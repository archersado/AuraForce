generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String                 @id @default(uuid())
  name                  String?
  email                 String                 @unique
  emailVerified         DateTime?              @map("email_verified")
  password              String?                @db.Text
  image                 String?
  pendingEmail          String?                @map("pending_email") @db.Text
  pendingEmailToken     String?                @map("pending_email_token") @db.Text
  pendingEmailExpires   DateTime?              @map("pending_email_expires")
  subscriptionLevel     String                 @default("FREE") @map("subscription_level")
  subscriptionStartDate DateTime?              @map("subscription_start_date")
  subscriptionEndDate   DateTime?              @map("subscription_end_date")
  subscriptionId        String?                @map("subscription_id")
  usageMetrics          Json?                  @map("usage_metrics")
  tenantId              String?                @map("tenant_id")
  tenantRole            String?                @map("tenant_role")
  createdAt             DateTime               @default(now()) @map("created_at")
  updatedAt             DateTime               @updatedAt @map("updated_at")
  accounts              Account[]
  claudeConversations   ClaudeConversation[]
  invoices              Invoice[]
  sessions              Session[]
  shareTokens           ShareToken[]
  skills                Skill[]
  subscriptions         Subscription[]
  auditLogs             TenantAuditLog[]
  privacySettings       UserPrivacySettings?
  settings              UserSettings?
  workspaceProjects     UserWorkspaceProject[]
  tenant                Tenant?                @relation(fields: [tenantId], references: [id])
  workflowSpecs         WorkflowSpec[]

  @@index([tenantId], map: "users_tenant_id_fkey")
  @@map("users")
}

model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId], map: "accounts_user_id_fkey")
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "sessions_user_id_fkey")
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Skill {
  id                  String               @id @default(uuid())
  title               String
  description         String?              @db.Text
  content             String               @db.LongText
  tags                Json?
  category            String?
  difficulty          String?              @default("beginner")
  userId              String               @map("user_id")
  isPublic            Boolean              @default(false) @map("is_public")
  filePath            String?              @map("file_path")
  metadata            Json?
  tenantId            String?              @map("tenant_id")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  claudeConversations ClaudeConversation[]
  tenant              Tenant?              @relation(fields: [tenantId], references: [id])
  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "skills_tenant_id_fkey")
  @@index([userId], map: "skills_user_id_fkey")
  @@map("skills")
}

model ClaudeConversation {
  id        String   @id @default(uuid())
  title     String?
  userId    String   @map("user_id")
  skillId   String?  @map("skill_id")
  projectId String?  @map("project_id")
  sessionId String?  @map("session_id")
  messages  Json
  metadata  Json?
  status    String   @default("active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  skill     Skill?   @relation(fields: [skillId], references: [id])
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, projectId])
  @@index([skillId], map: "claude_conversations_skill_id_fkey")
  @@map("claude_conversations")
}

model SkillTemplate {
  id            String   @id @default(uuid())
  title         String
  description   String?  @db.Text
  content       String   @db.LongText
  tags          Json?
  category      String
  difficulty    String   @default("beginner")
  isOfficial    Boolean  @default(false) @map("is_official")
  filePath      String   @map("file_path")
  metadata      Json?
  downloadCount Int      @default(0) @map("download_count")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("skill_templates")
}

model UserSettings {
  id                 String  @id @default(uuid())
  userId             String  @unique @map("user_id")
  theme              String  @default("system")
  language           String  @default("zh-CN")
  notifications      Json?
  claudePreferences  Json?
  autoExpandTools    Boolean @default(false) @map("auto_expand_tools")
  showRawParameters  Boolean @default(false) @map("show_raw_parameters")
  showThinking       Boolean @default(true) @map("show_thinking")
  autoScrollToBottom Boolean @default(true) @map("auto_scroll_to_bottom")
  sendByCtrlEnter    Boolean @default(false) @map("send_by_ctrl_enter")
  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model Subscription {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  level        String
  startDate    DateTime  @map("start_date")
  endDate      DateTime? @map("end_date")
  status       String    @default("active")
  amount       Decimal   @db.Decimal(10, 2)
  currency     String    @default("CNY")
  billingCycle String    @map("billing_cycle")
  externalId   String?   @map("external_id")
  metadata     Json?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "subscriptions_user_id_fkey")
  @@map("subscriptions")
}

model Invoice {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  subscriptionId String?   @map("subscription_id")
  invoiceNumber  String    @unique @map("invoice_number")
  amount         Decimal   @db.Decimal(10, 2)
  currency       String    @default("CNY")
  status         String    @default("pending")
  dueDate        DateTime  @map("due_date")
  paidAt         DateTime? @map("paid_at")
  downloadUrl    String?   @map("download_url")
  metadata       Json?
  createdAt      DateTime  @default(now()) @map("created_at")
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "invoices_user_id_fkey")
  @@map("invoices")
}

model Tenant {
  id          String             @id @default(uuid())
  name        String
  description String?            @db.Text
  settings    Json               @map("settings")
  plan        String             @default("TEAM")
  maxMembers  Int                @default(10)
  isActive    Boolean            @default(true) @map("is_active")
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")
  skills      Skill[]
  auditLogs   TenantAuditLog[]
  invitations TenantInvitation[]
  members     User[]

  @@map("tenants")
}

model TenantInvitation {
  id         String    @id @default(uuid())
  tenantId   String    @map("tenant_id")
  email      String
  role       String
  token      String    @unique
  expiresAt  DateTime  @map("expires_at")
  acceptedAt DateTime? @map("accepted_at")
  status     String    @default("pending")
  createdAt  DateTime  @default(now()) @map("created_at")
  tenant     Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId], map: "tenant_invitations_tenant_id_fkey")
  @@map("tenant_invitations")
}

model TenantAuditLog {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  userId    String   @map("user_id")
  action    String
  details   Json?
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@index([userId], map: "tenant_audit_logs_user_id_fkey")
  @@map("tenant_audit_logs")
}

model UserPrivacySettings {
  id                     String   @id @default(uuid())
  userId                 String   @unique @map("user_id")
  allowPublicProfile     Boolean  @default(true) @map("allow_public_profile")
  allowSearchIndexing    Boolean  @default(true) @map("allow_search_indexing")
  showEmail              Boolean  @default(false) @map("show_email")
  showRealName           Boolean  @default(true) @map("show_real_name")
  thirdPartyDataSharing  Boolean  @default(false) @map("third_party_data_sharing")
  marketingEmails        Boolean  @default(false) @map("marketing_emails")
  analyticsEnabled       Boolean  @default(true) @map("analytics_enabled")
  defaultSkillVisibility String   @default("private") @map("default_skill_visibility")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_privacy_settings")
}

model ShareToken {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  contentId   String    @map("content_id")
  contentType String    @map("content_type")
  token       String    @unique
  expiresAt   DateTime? @map("expires_at")
  accessCount Int       @default(0) @map("access_count")
  maxAccess   Int?      @map("max_access")
  password    String?   @db.Text
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId], map: "share_tokens_user_id_fkey")
  @@map("share_tokens")
}

model ContentAccessLog {
  id          String   @id @default(uuid())
  contentId   String   @map("content_id")
  contentType String   @map("content_type")
  shareToken  String?  @map("share_token")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  visitedAt   DateTime @default(now()) @map("visited_at")

  @@index([contentId, visitedAt])
  @@index([shareToken])
  @@map("content_access_logs")
}

model WorkflowSpec {
  id            String               @id @default(uuid())
  name          String
  description   String?              @db.Text
  version       String?              @default("1.0.0")
  author        String?
  ccPath        String               @unique @map("cc_path")
  ccPathVersion Int                  @default(1) @map("cc_path_version")
  userId        String               @map("user_id")
  status        String               @default("deployed")
  syncStatus    String               @default("synced") @map("sync_status")
  metadata      Json?
  contentHash   String?              @map("content_hash")
  pathHistory   Json?                @map("path_history")
  lastSyncAt    DateTime             @default(now()) @map("last_sync_at")
  deployedAt    DateTime             @default(now()) @map("deployed_at")
  updatedAt     DateTime             @updatedAt @map("updated_at")
  dependencies  WorkflowDependency[] @relation("SourceWorkflow")
  dependents    WorkflowDependency[] @relation("TargetWorkflow")
  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([ccPath])
  @@index([syncStatus])
  @@index([status, userId])
  @@index([contentHash])
  @@map("workflow_specs")
}

model WorkflowDependency {
  id               String       @id @default(uuid())
  sourceWorkflowId String       @map("source_workflow_id")
  targetWorkflowId String       @map("target_workflow_id")
  dependencyType   String       @map("dependency_type")
  createdAt        DateTime     @default(now()) @map("created_at")
  sourceWorkflow   WorkflowSpec @relation("SourceWorkflow", fields: [sourceWorkflowId], references: [id], onDelete: Cascade)
  targetWorkflow   WorkflowSpec @relation("TargetWorkflow", fields: [targetWorkflowId], references: [id], onDelete: Cascade)

  @@unique([sourceWorkflowId, targetWorkflowId, dependencyType])
  @@index([sourceWorkflowId])
  @@index([targetWorkflowId])
  @@map("workflow_dependencies")
}

model UserWorkspaceProject {
  id                 String    @id @default(uuid())
  userId             String    @map("user_id")
  name               String
  path               String
  description        String?   @db.Text
  workflowTemplateId String?   @map("workflow_template_id")
  lastOpenedAt       DateTime? @map("last_opened_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, name])
  @@map("user_workspace_projects")
}

// Workspace Folder Model - 工作区文件夹模型（使用文件系统路径）
model WorkspaceFolder {
  id            String               @id @default(uuid())
  name          String               // 文件夹名称
  path          String               @db.Text    // 文件夹路径（相对于 workspace 根目录）
  description   String?              @db.Text    // 文件夹描述
  createdAt     DateTime             @default(now()) @map("created_at")
  updatedAt     DateTime             @updatedAt @map("updated_at")
  
  @@unique([workspaceId, name, path])
  @@map("workspace_folders")
}

// Workspace File Model - 工作区文件模型
model WorkspaceFile {
  id            String               @id @default(uuid())
  folderId      String               @map("folder_id")  // 所属文件夹
  name          String               // 文件名
  path          String               @db.Text    // 文件路径（相对于 folder）
  type          String               // 类型：file, folder
  size          BigInt?             @db.BigInt    // 文件大小（字节）
  content       String?             @db.LongText   // 文件内容（仅小文本文件预览）
  metadata      Json?              // 扩展信息
  
  folder          WorkspaceFolder     @relation(fields: [folderId], references: [id], onDelete: Cascade)
  createdByUserId String?            @map("created_by_user_id")
  createdAt     DateTime             @default(now()) @map("created_at")
  updatedAt     DateTime             @updatedAt @map("updated_at")

  @@unique([folderId, name, path])
  @@map("workspace_files")
}

// Workspace Session Model - 编辑会话状态模型
model WorkspaceSession {
  id            String               @id @default(uuid())
  workspaceType  String             @default("user")  // user | organization | shared
  folderPath    String               @db.Text    // 当前打开的文件夹路径
  filePaths     Json              // 打开的文件标签页
  scrollPosition   Json              // 滚动位置
  editorState  Json              // 编辑器状态（保存、光标位置等）
  
  createdByUserId String            @map("created_by_user_id")
  createdAt     DateTime             @default(now()) @map("created_at")
  updatedAt     DateTime             @updatedAt @map("updated_at")


generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}


// Workspace Folder Model - 工作区文件夹模型（使用文件系统路径）
model WorkspaceFolder {
  id         String   @id @default(uuid())
  name        String
  path        String   @db.Text    // 文件夹路径（相对于 workspace 根目录）
  description String?  @db.Text    // 文件夹描述
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([workspaceId, name, path])
  @@map("workspace_folders")
}

// Workspace File Model - 工作区文件模型
model WorkspaceFile {
  id      String   @id @default(uuid())
  folderId String   @map("folder_id")  // 所属文件夹
  name     String   // 文件名
  path     String   @db.Text    // 文件路径（相对于 folder）
  type     String   // 类型：file, folder
  size     BigInt? @db.BigInt    // 文件大小（字节）
  lastModified DateTime? @map("last_modified")
  content String?  @db.LongText    // 文件内容预览（仅小文本）
  metadata Json?  @db.Json    // 扩展信息

  folder           WorkspaceFolder @relation(fields: [folderId], references: [id], onDelete: Cascade)
}

// Workspace Session Model - 编辑会话状态模型
model WorkspaceSession {
  id            String   @id @default(uuid())
  workspaceType  String  @default("user")  // user | organization | shared
  folderPath    String   @db.Text    // 当前打开的文件夹路径
  filePaths     Json              // 打开的文件标签页
  scrollPosition Json            // 滚动位置
  editorState   Json              // 编辑器状态（保存、光标位置等）
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
}

// 更新 User 模型，添加 workspaceFolders 关系
model User {
  // ... 保留 User 模型中所有现有字段 ...
  workspaceFolders WorkspaceFolder[]  // 添加工作区文件夹关系

  @@index([email])
  @@map("users")
}
