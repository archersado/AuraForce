# å·¥ä½œæµå¯è§æ€§é—®é¢˜åˆ†ææŠ¥å‘Š

**é—®é¢˜ï¼š** ä¸Šä¼ å·¥ä½œæµåï¼Œå…¶ä»–ç”¨æˆ·çœ‹ä¸åˆ°

**åˆ†ææ—¶é—´ï¼š** 2025-02-03 20:30 GMT+8

---

## ğŸ” é—®é¢˜åŸå› 

### API æŸ¥è¯¢é€»è¾‘ï¼ˆ`src/app/api/workflows/route.ts`ï¼‰

```typescript
// å½“å‰æ­£ç¡®é€»è¾‘
if (session?.userId) {
  where.OR = [
    { userId: session.userId },        // æ˜¾ç¤ºç”¨æˆ·è‡ªå·±çš„æ‰€æœ‰å·¥ä½œæµ
    { visibility: 'public' },         // æ˜¾ç¤ºæ‰€æœ‰å…¬å¼€çš„å·¥ä½œæµ
  ];
} else {
  where.visibility = 'public';         // æœªç™»å½•åªèƒ½çœ‹å…¬å¼€å·¥ä½œæµ
}
```

**è¿™ä¸ªé€»è¾‘æ˜¯æ­£ç¡®çš„ï¼**é—®é¢˜åœ¨äºï¼š

---

## âŒ å®é™…é—®é¢˜ï¼šå·¥ä½œæµåˆ›å»ºæ—¶æœªè®¾ç½® visibility

### 1. æ•°æ®åº“ schema ä¸­çš„é»˜è®¤å€¼

æ£€æŸ¥ `prisma/schema.prisma` ä¸­çš„ `WorkflowSpec` æ¨¡å‹ï¼š

```prisma
model WorkflowSpec {
  id          String    @id @default(uuid())
  name        String
  visibility  String?   // âŒ æ²¡æœ‰é»˜è®¤å€¼ï¼
  // ...
}
```

**é—®é¢˜ï¼š** `visibility` å­—æ®µæ²¡æœ‰é»˜è®¤å€¼ï¼Œå¦‚æœåˆ›å»ºå·¥ä½œæµæ—¶ä¸æŒ‡å®šï¼Œåˆ™ä¸º `null`

### 2. å·¥ä½œæµåˆ›å»ºé€»è¾‘

å½“å‰ï¼ˆæ¨æµ‹ï¼‰å·¥ä½œæµåˆ›å»ºä»£ç ï¼š
```typescript
// âŒ é”™è¯¯ï¼šæœªè®¾ç½® visibility
await prisma.workflowSpec.create({
  data: {
    name: workflowName,
    description: workflowDescription,
    // visibility æœªè®¾ç½®ï¼Œé»˜è®¤ä¸º null
  },
});
```

### 3. å…¶ä»–ç”¨æˆ·æŸ¥è¯¢æ—¶ï¼Œvisibility=null çš„å·¥ä½œæµä¸ä¼šæ˜¾ç¤º

```typescript
// å…¶ä»–ç”¨æˆ·æŸ¥è¯¢
where.OR = [
  { userId: session.userId },
  { visibility: 'public' },  // âŒ visibility=null çš„ä¸åŒ¹é…ï¼Œä¸æ˜¾ç¤º
];
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šæ•°æ®åº“å±‚é¢è®¾ç½®é»˜è®¤å€¼ï¼ˆæ¨èï¼‰

ä¿®æ”¹ `prisma/schema.prisma`ï¼š

```prisma
model WorkflowSpec {
  id          String    @id @default(uuid())
  name        String
  visibility  String    @default("public")  // âœ… æ·»åŠ é»˜è®¤å€¼
  // ...
}
```

ç„¶åè¿è¡Œï¼š
```bash
npx prisma migrate dev
```

### æ–¹æ¡ˆ Bï¼šä»£ç å±‚é¢æŒ‡å®š visibilityï¼ˆå¤‡é€‰ï¼‰

ä¿®æ”¹å·¥ä½œæµåˆ›å»ºä»£ç ï¼š

```typescript
await prisma.workflowSpec.create({
  data: {
    name: workflowName,
    description: workflowDescription,
    visibility: 'public',  // âœ… æ˜ç¡®è®¾ç½®ä¸º public
  },
});
```

### æ–¹æ¡ˆ Cï¼šUI æ·»åŠ å¯è§æ€§é€‰æ‹©ï¼ˆæœ€ä½³ç”¨æˆ·ä½“éªŒï¼‰

åœ¨å·¥ä½œæµåˆ›å»º/ä¸Šä¼ è¡¨å•ä¸­æ·»åŠ é€‰é¡¹ï¼š

```tsx
<select name="visibility">
  <option value="public">å…¬å¼€ - æ‰€æœ‰ç”¨æˆ·å¯è§</option>
  <option value="private">ç§æœ‰ - ä»…è‡ªå·±å¯è§</option>
</select>
```

---

## ğŸ“‹ å»ºè®®çš„å®æ–½æ­¥éª¤

### çŸ­æœŸä¿®å¤ï¼ˆç«‹å³å¯ç”¨ï¼‰

1. **ä¿®æ”¹æ•°æ®åº“ schemaï¼Œè®¾ç½®é»˜è®¤å€¼ä¸º 'public'**
   ```bash
   npx prisma migrate dev --name add_workflow_visibility_default
   ```

2. **æ›´æ–°ç°æœ‰å·¥ä½œæµæ•°æ®**
   ```sql
   UPDATE workflow_specs
   SET visibility = 'public'
   WHERE visibility IS NULL;
   ```

### ä¸­æœŸæ”¹è¿›ï¼ˆæ›´å¥½ä½“éªŒï¼‰

3. **åœ¨å·¥ä½œæµä¸Šä¼ ç•Œé¢æ·»åŠ å¯è§æ€§é€‰é¡¹**

4. **æä¾›"è®¾ç½®ä¸ºå…¬å¼€/ç§æœ‰"çš„åˆ‡æ¢åŠŸèƒ½**

### é•¿æœŸä¼˜åŒ–

5. **æ·»åŠ æƒé™ç®¡ç†ç³»ç»Ÿ**
   - å·¥ä½œæµæ‰€æœ‰è€…å¯ä»¥ä¿®æ”¹å¯è§æ€§
   - æä¾›å·¥ä½œæµè¯¦æƒ…é¡µæ˜¾ç¤ºå¯è§æ€§çŠ¶æ€
   - æä¾›"å‘å¸ƒåˆ°å¸‚åœº"åŠŸèƒ½

---

## ğŸ¯ å¯¹ç”¨æˆ·çš„å½±å“

### å½“å‰çŠ¶æ€

**ç”¨æˆ· A åˆ›å»ºå·¥ä½œæµï¼š**
- visibility = nullï¼ˆæœªæŒ‡å®šï¼‰
- **ç»“æœï¼š** ç”¨æˆ· A å¯ä»¥çœ‹åˆ°ï¼Œå…¶ä»–ç”¨æˆ·çœ‹ä¸åˆ° âŒ

**å…¶ä»–ç”¨æˆ· B æŸ¥è¯¢ï¼š**
- åªçœ‹åˆ° visibility = 'public' çš„å·¥ä½œæµ
- **ç»“æœï¼š** çœ‹ä¸åˆ°ç”¨æˆ· A çš„å·¥ä½œæµ âŒ

### ä¿®å¤åçŠ¶æ€

**ç”¨æˆ· A åˆ›å»ºå·¥ä½œæµï¼š**
- visibility = 'public'ï¼ˆé»˜è®¤ï¼‰
- **ç»“æœï¼š** æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥çœ‹åˆ° âœ…

**ç”¨æˆ· B æŸ¥è¯¢ï¼š**
- çœ‹åˆ°æ‰€æœ‰å…¬å¼€å·¥ä½œæµï¼ŒåŒ…æ‹¬ç”¨æˆ· A çš„
- **ç»“æœï¼š** å·¥ä½œæµå¸‚åœºå¯ä»¥çœ‹åˆ° âœ…

---

## ğŸ”§ ä¿®å¤éªŒè¯

ä¿®å¤åï¼ŒéªŒè¯ä»¥ä¸‹å‡ ç‚¹ï¼š

1. **æ–°åˆ›å»ºçš„å·¥ä½œæµé»˜è®¤ä¸ºå…¬å¼€**
   - åˆ›å»ºå·¥ä½œæµ
   - å…¶ä»–ç”¨æˆ·å¯ä»¥æœç´¢å’ŒæŸ¥çœ‹

2. **ç°æœ‰å·¥ä½œæµæ•°æ®ä¿®å¤**
   - å°† visibility=null çš„è®°å½•æ›´æ–°ä¸º 'public'
   - é‡æ–°æœç´¢åŠŸèƒ½æ­£å¸¸

3. **æƒé™é€‰é¡¹åŠŸèƒ½æ­£å¸¸**
   - ç”¨æˆ·å¯ä»¥é€‰æ‹©å…¬å¼€/ç§æœ‰
   - ç§æœ‰å·¥ä½œæµåªæœ‰è‡ªå·±å¯è§

---

**æŠ¥å‘Š generated: 2025-02-03 20:30 GMT+8**
