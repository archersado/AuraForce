# File Operations UI 设计文档

**Story:** STORY-14-7 (File Operations CRUD)
**Epic:** EPIC-14 (Workspace Editor & File Management)
**Sprint:** Sprint 1
**设计日期:** 2025-02-02
**设计师:** Product Designer
**预计时间:** 1 小时
**优先级:** P1

---

## 🎯 设计目标

设计一套完整、直观且安全的文件操作界面，支持文件的创建、读取、更新、删除(CRUD)以及上传、下载、重命名等高级操作。界面设计应确保用户操作的直观性、错误操作的预防性以及操作反馈的及时性，提供类似 VS Code / Atom 的文件管理体验。

---

## 📐 整体布局

### 文件树面板结构

```
┌──────────────────────────────────┐
│  📁 files                 ─ +    │ ← 侧边栏标题 + 操作按钮
├──────────────────────────────────┤
│ ┌─────────────────────────────┐ │
│ │ 📁 src/           ▾ >       │ │
│ │ ┌─────────────────────────┐ │ │
│ │ │ 📁 components/    >     │ │ │
│ │ │ 📄 app.tsx              │ │ │
│ │ │ 📄 layout.tsx            │ │ │
│ │ │ 📁 hooks/          >    │ │ │
│ │ │ 📁 utils/          >    │ │ │
│ │ └─────────────────────────┘ │ │
│ │                             │ │
│ │ 📁 public/          ▾ >     │ │
│ │ ┌─────────────────────────┐ │ │
│ │ │ 📄 favicon.ico          │ │ │
│ │ │ 📄 logo.png             │ │ │
│ │ └─────────────────────────┘ │ │
│ │                             │ │
│ │ 📜 .gitignore               │ │
│ │ 📜 package.json             │ │
│ │ 📜 README.md                │ │
│ │                             │ │
│ └─────────────────────────────┘ │
│  ↑    ↑           ↑             │
│ 展开  更多操作    文件类型图标    │
└──────────────────────────────────┘
```

### 侧边栏标题区域

**尺寸:** 高度 40px
**内容:**
```
左侧: 📁 files (工作空间名称)
右侧: ─ (分割线)  + (新建文件按钮)
```

**下拉菜单 (+ 按钮):**
```
┌─────────────────┐
│ 📄 新建文件       │
│ 📁 新建文件夹     │
│ ⬆️ 上传文件...   │
├─────────────────┤
│ 📂 从 Git 导入   │
│ ─────────────── │
│ ⚙️ 文件夹设置... │
└─────────────────┘
```

---

## 📄 文件创建界面

### 新建文件弹窗

**触发方式:**
- 右键点击文件树空白区域 → "新建文件"
- 点击侧边栏 "+" 按钮 → "新建文件"
- 快捷键: `Ctrl+N` / `Cmd+N`

**弹窗尺寸:**
- 宽度: 450px
- 高度: 320px
- 居中显示

**弹窗内容:**
```
┌───────────────────────────────────────┐
│  新建文件                               × │
├───────────────────────────────────────┤
│                                       │
│  文件名: [ _______________________ ]  │
│           ^ 光标焦点，默认选中        │
│                                       │
│  保存位置:                             │
│  📁 src/ (默认当前目录)            │
│                                       │
│  文件类型:                             │
│  ┌─────────────────────────────────┐ │
│  │ TypeScript (.tsx)               │ │
│  │ JavaScript (.js)                │ │
│  │ CSS (.css)                      │ │
│  │ HTML (.html)                    │ │
│  │ Markdown (.md)                  │ │
│  │ JSON (.json)                    │ │
│  │ YAML (.yaml)                    │ │
│  │ Shell (.sh)                     │ │
│  └─────────────────────────────────┘ │
│                                       │
│  ☐ 使用模板 (可选)                     │
│  ┌─────────────────────────────────┐ │
│  │ React 组件模板                   │ │
│  │ Node.js 模块模板                 │ │
│  │ 空文件                           │ │
│  └─────────────────────────────────┘ │
│                                       │
├───────────────────────────────────────┤
│            [取消]    [创建]           │
│            ^ 虚线   ^ 主按钮           │
└───────────────────────────────────────┘
```

**操作顺序:**
1. 输入文件名
2. 自动根据扩展名匹配文件类型
3. 选择保存位置(支持点击文件树选择)
4. 选择模板(可选)
5. 点击"创建"

**验证规则:**
- 文件名不能为空
- 文件名不能包含 `/ \ : * ? " < > |`
- 同目录下不能有重名文件
- 文件夹路径必须存在

**错误提示:**
```tsx
if (fileName === '') {
  return <InputError>请输入文件名</InputError>;
}

if (invalidCharPattern.test(fileName)) {
  return <InputError>文件名包含非法字符: / \\ : * ? " < > |</InputError>;
}

if (fileExists) {
  return <InputError>文件已存在，请使用其他名称</InputError>;
}
```

---

### 新建文件夹弹窗

**触发方式:**
- 右键点击文件树 → "新建文件夹"
- "+" 按钮菜单 → "新建文件夹"
- 快捷键: `Ctrl+Shift+N` / `Cmd+Shift+N`

**弹窗尺寸:**
- 宽度: 400px
- 高度: 180px

**弹窗内容:**
```
┌───────────────────────────────────────┐
│  新建文件夹                             × │
├───────────────────────────────────────┤
│                                       │
│  文件夹名称: [ ___________________ ]  │
│                                       │
│  创建位置:                             │
│  📁 src/                          │
│                                       │
├───────────────────────────────────────┤
│            [取消]    [创建]           │
└───────────────────────────────────────┘
```

**成功反馈:**
- Toast 提示: `✅ 文件夹 "components" 已创建`
- 文件树自动展开到新文件夹

---

## ✏️ 文件重命名弹窗

### 右键上下文菜单

**文件项右键菜单:**
```
┌─────────────────────┐
│ 📝 重命名           │ ← 主要操作，第一位
│ ☐ 将文件移动到...   │
│ ───────────────────│
│ 📋 复制             │
│ 📋 剪切             │
│ 📋 粘贴             │
│ 📋 复制路径         │
│ ✓ 复制相对路径      │
│ ───────────────────│
│ 📥 下载             │
│ ⬆️ 替换内容...      │
│ ───────────────────│
│ 🗑️ 删除             │ ← 危险操作，最后一位，红色
│ 🔒 移动到回收站    │
│ ───────────────────│
│ ℹ️ 文件信息         │
└─────────────────────┘
```

### 重命名弹窗

**触发方式:**
- 右键点击文件 → "重命名"
- 快捷键: `F2` (选中文件时)
- 双击文件名(延迟 500ms)

**弹窗尺寸:**
- 宽度: 400px
- 高度: 160px

**弹窗内容:**
```
┌───────────────────────────────────────┐
│  重命名                                 × │
├───────────────────────────────────────┤
│  📄 原文件名: app.tsx                  │
│                                       │
│  新文件名: [ app-new.tsx          ]   │
│               ^ 光标焦点，去除扩展名   │
│                                       │
│  ⚠️ 提示: 重命名将更新所有相关引用      │
│                                       │
├───────────────────────────────────────┤
│            [取消]    [确定]           │
└───────────────────────────────────────┘
```

**智能重命名:**
- 默认只选中文件名部分，不包含扩展名
- 自动检测文件类型，提供扩展名建议
- 如果文件被引用，显示引用数量
```
⚠️ 此文件被 3 个其他文件引用，重命名将更新这些引用
```

---

## 🗑️ 文件删除确认弹窗

### 删除触发

**触发方式:**
- 右键点击文件 → "删除"
- 选中文件后按 `Delete` 键
- 拖拽到回收站图标

### 删除确认弹窗

**单个文件:**
```
┌───────────────────────────────────────┐
│  ⚠️ 确认删除                           │
├───────────────────────────────────────┤
│                                       │
│  确定要删除以下文件吗？                  │
│                                       │
│  📄 app.tsx                          │
│  位置: src/app.tsx                   │
│  大小: 2.3 KB                         │
│                                       │
│  ⚠️ 此操作不可撤销！                    │
│                                       │
│  ☐ "不再显示此确认" (危险选项)          │
│                                       │
├───────────────────────────────────────┤
│            [取消]    [删除]           │
│            ^ 主按钮   ^ 危险按钮(红色)  │
└───────────────────────────────────────┘
```

**文件夹(包含文件):**
```
┌───────────────────────────────────────┐
│  ⚠️ 确认删除                           │
├───────────────────────────────────────┤
│                                       │
│  确定要删除以下文件夹及其所有内容吗？     │
│                                       │
│  📁 components/                      │
│  内容: 3 个文件, 2 个子文件夹           │
│  位置: src/components/               │
│  总大小: 45.2 KB                      │
│                                       │
│  ⚠️ 此操作不可撤销！                    │
│                                       │
├───────────────────────────────────────┤
│            [取消]    [删除]           │
└───────────────────────────────────────┘
```

**批量删除(多个文件):**
```
┌───────────────────────────────────────┐
│  ⚠️ 确认删除                           │
├───────────────────────────────────────┤
│                                       │
│  确定要删除以下 5 个文件吗？             │
│                                       │
│  📄 app.tsx           (2.3 KB)        │
│  📄 component.tsx     (4.1 KB)        │
│  📄 utils.ts          (1.8 KB)        │
│  📁 icons/           (12.5 KB)        │
│  📜 README.md          (512 B)        │
│                                       │
│  总计: 21.2 KB                         │
│                                       │
│  ⚠️ 此操作不可撤销！                    │
│                                       │
├───────────────────────────────────────┤
│            [取消]    [删除全部]        │
└───────────────────────────────────────┘
```

### 删除操作反馈

**删除成功:**
```
┌───────────────────────────────────────┐
│  ✅ 删除成功                           │
│      文件 "app.tsx" 已删除             │
│      [撤销] (30秒后消失)               │
└───────────────────────────────────────┘
```

**撤销功能(重要):**
- 删除后 30 秒内可点击"撤销"恢复文件
- 文件移动到临时"回收站"区域
- 30 秒后永久删除
- 30 秒内重复删除相同文件更新计时器

**删除失败:**
```
┌───────────────────────────────────────┐
│  ❌ 删除失败                           │
│      错误: 文件正在被其他程序使用       │
│      [重试] [取消]                     │
└───────────────────────────────────────┘
```

---

## ⬆️ 文件上传界面

### 上传触发

**触发方式:**
- 点击 "+" 按钮 → "上传文件..."
- 拖拽文件到文件树区域
- 文件树右键 → "上传文件..."

### 拖拽上传区域

当文件拖拽到文件树时，显示拖拽区域:
```
┌───────────────────────────────────────┐
│                                       │
│           💡 拖拽文件到此处            │
│                                       │
│                                       │
│       📂 上传到: src/              │
│                                       │
│        ✓ 支持多文件上传                │
│        ✓ 自动识别文件类型              │
│        ✓ 自动创建文件夹结构            │
│                                       │
│                                       │
│  ┌─────────────────────────────────┐ │
│  │  或点击选择文件                  │ │
│  └─────────────────────────────────┘ │
│                                       │
└───────────────────────────────────────┘
```

**拖拽样式:**
- 背景色: `rgba(0, 122, 204, 0.1)`
- 边框: 2px 虚线 `#007acc`
- 圆角: 8px
- 图标尺寸: 64 × 64px

### 上传进度弹窗

```
┌───────────────────────────────────────────────┐
│  ⬆️ 文件上传                                    │
├───────────────────────────────────────────────┤
│                                               │
│  正在上传 3 个文件到 src/                   │
│                                               │
│  📄 image.png                     [██████████░] 85% │
│       2.3 MB / 2.7 MB                         │
│       预计剩余: 5 秒                           │
│                                               │
│  📄 screenshot.jpg                 [████████░░░] 65% │
│       856 KB / 1.3 MB                         │
│                                               │
│  📜 notes.txt                      [████░░░░░░░] 40% │
│       12 KB / 30 KB                           │
│                                               │
│  总进度: [██████████░░░░░░░░] 63%            │
│                                               │
│  已上传: 3.2 MB / 5.1 MB                     │
│                                               │
│  ┌─────────────────────────────────────────┐ │
│  │  [取消全部]  [后台运行]  [完成]         │ │
│  └─────────────────────────────────────────┘ │
│                                               │
└───────────────────────────────────────────────┘
```

**上传状态指示:**
- 🔄 上传中: 蓝色进度条
- ✅ 上传成功: 绿色对勾
- ❌ 上传失败: 红色错误 + 重试按钮
- ⏸️ 暂停上传: 黄色暂停图标

### 文件类型支持

| 类型 | 扩展名 | 最大大小 | 操作 |
|------|--------|---------|------|
| 文本代码 | *.js, *.ts, *.tsx, *.py, *.java, *.go 等 | 10MB | 自动语法高亮 |
| 文档 | *.md, *.txt, *.json, *.yaml, *.xml | 5MB | Markdown 预览 |
| 图片 | *.png, *.jpg, *.jpeg, *.gif, *.svg, *.webp | 10MB | 图片预览 |
| 文档 | *.pdf | 50MB | PDF 预览 |
| 音频 | *.mp3, *.wav, *.m4a | 20MB | 音频播放器 |
| 视频 | *.mp4, *.webm, *.mov | 100MB | 视频播放器 |
| 压缩包 | *.zip, *.tar, *.gz | 100MB | 显示大小(不支持预览) |
| 其他 | * | 100MB | 显示图标 |

### 文件重复处理

**重复文件确认弹窗:**
```
┌───────────────────────────────────────┐
│  ⚠️ 文件已存在                         │
├───────────────────────────────────────┤
│                                       │
│  文件 "image.png" 已存在               │
│                                       │
│  原文件: 2025-01-15 14:23 (2.3 MB)   │
│  新文件: 2025-02-02 10:45 (2.3 MB)   │
│                                       │
│  如何处理？                            │
│                                       │
│  ○ 覆盖原文件                          │
│  ○ 重命名新文件 (image-1.png)          │
│  ○ 跳过此文件                          │
│   ☑ 对所有重复文件应用相同操作           │
│                                       │
├───────────────────────────────────────┤
│        [跳过]    [应用]    [确定]     │
└───────────────────────────────────────┘
```

**自动命名策略:**
```
原文件名: image.png
重复文件: image-1.png
再次重复: image-2.png
...
```

### 上传完成反馈

**单个文件上传成功:**
```
┌───────────────────────────────────────┐
│  ✅ 上传成功                           │
│      文件 "image.png" 已上传           │
│      [在编辑器中打开] [关闭]            │
└───────────────────────────────────────┘
```

**批量上传成功:**
```
┌───────────────────────────────────────┐
│  ✅ 上传完成                           │
│      3 个文件已成功上传                 │
│      • image.png                      │
│      • screenshot.jpg                  │
│      • notes.txt                      │
│      [在编辑器中打开] [关闭]            │
└───────────────────────────────────────┘
```

---

## ✅ 操作成功/失败提示

### Toast 通知设计

**Toast 位置:** 右下角，垂直堆叠

**成功提示:**
```
┌───────────────────────────────────────┐
│  ✅ 操作成功                           │
│      文件已保存到 src/app.tsx        │
│      [查看] [关闭]                    │
└───────────────────────────────────────┘
```
- 背景色: `#2e7d32` (success green)
- 图标: ✓ 绿色对勾
- 自动关闭: 3 秒
- 可手动关闭

**警告提示:**
```
┌───────────────────────────────────────┐
│  ⚠️ 文件未保存                         │
│      关闭前请先保存修改                │
│      [保存] [忽略]                     │
└───────────────────────────────────────┘
```
- 背景色: `#f57c00` (warning orange)
- 图标: ⚠️ 警告
- 不自动关闭(需用户操作)

**错误提示:**
```
┌───────────────────────────────────────┐
│  ❌ 操作失败                           │
│      错误: 权限不足，无法写入文件       │
│      [重试] [查看详情] [关闭]          │
└───────────────────────────────────────┘
```
- 背景色: `#c62828` (error red)
- 图标: ❌ 错误
- 不自动关闭
- 支持查看完整错误详情

**信息提示:**
```
┌───────────────────────────────────────┐
│  ℹ️ 提示                               │
│      文件已自动保存                    │
└───────────────────────────────────────┘
```
- 背景色: `#1565c0` (info blue)
- 图标: ℹ️ 信息
- 自动关闭: 2 秒

### 内联消息设计

**文件操作时的即时反馈:**
```
src/
  ├── components/
  │   └── Button.tsx            ✅ 已保存 (2秒前)
  ├── utils.ts                  ⚠️ 有未保存的修改
  └── app.tsx                   🔄 保存中...
```

**图标说明:**
- ✅ 已保存
- ⚠️ 有未保存的修改
- 🔄 保存中...
- ❌ 保存失败
- ⏸️ 同步中...

---

## 🎨 文件图标设计

### 文件类型图标

**代码文件:**

| 图标 | 文件类型 | 扩展名 |
|------|---------|--------|
| 🔵 | JavaScript | *.js |
| 🔵 | TypeScript | *.ts, *.tsx |
| 🟡 | React | *.jsx, *.tsx |
| 🟡 | Vue | *.vue |
| 🟡 | Angular | *.component.ts |
| 🟢 | Python | *.py |
| 🟢 | Java | *.java |
| 🟢 | Go | *.go |
| 🟢 | Rust | *.rs |
| 🟢 | C/C++ | *.c, *.cpp, *.h, *.hpp |

**样式文件:**

| 图标 | 文件类型 | 扩展名 |
|------|---------|--------|
| 🎨 | CSS | *.css |
| 🎨 | SCSS | *.scss, *.sass |
| 🎨 | Less | *.less |
| 🎨 | Stylus | *.styl |

**配置文件:**

| 图标 | 文件类型 | 扩展名 |
|------|---------|--------|
| ⚙️ | JSON | *.json |
| ⚙️ | YAML | *.yaml, *.yml |
| ⚙️ | XML | *.xml |
| ⚙️ | TOML | *.toml |
| ⚙️ | INI | *.ini |

**文档文件:**

| 图标 | 文件类型 | 扩展名 |
|------|---------|--------|
| 📝 | Markdown | *.md |
| 📄 | Text | *.txt |
| 📄 | PDF | *.pdf |
| 📄 | Word | *.doc, *.docx |
| 📄 | Excel | *.xls, *.xlsx |

**媒体文件:**

| 图标 | 文件类型 | 扩展名 |
|------|---------|--------|
| 🖼️ | PNG | *.png |
| 🖼️ | JPEG | *.jpg, *.jpeg |
| 🖼️ | GIF | *.gif |
| 🖼️ | SVG | *.svg |
| 🖼️ | WebP | *.webp |
| 🎵 | Audio | *.mp3, *.wav, *.m4a |
| 🎬 | Video | *.mp4, *.webm, *.mov |

**压缩文件:**

| 图标 | 文件类型 | 扩展名 |
|------|---------|--------|
| 📦 | Zip | *.zip |
| 📦 | Tar | *.tar, *.tar.gz |
| 📦 | Rar | *.rar |

---

## 🎭 交互设计

### 快捷键

| 操作 | 快捷键 | 说明 |
|------|--------|------|
| 新建文件 | `Ctrl+N` | 在当前目录 |
| 新建文件夹 | `Ctrl+Shift+N` | 在当前目录 |
| 重命名 | `F2` | 选中文件时 |
| 删除 | `Delete` | 选中文件时 |
| 永久删除 | `Shift+Delete` | 跳过回收站 |
| 复制 | `Ctrl+C` | 复制文件 |
| 剪切 | `Ctrl+X` | 剪切文件 |
| 粘贴 | `Ctrl+V` | 粘贴文件 |
| 刷新文件树 | `Ctrl+R` | 重新加载 |

### 键盘导航

| 按键 | 操作 |
|------|------|
| `↑↓` | 导航文件列表 |
| `→` | 展开文件夹 |
| `←` | 折叠文件夹 |
| `Enter` | 打开文件 |
| `Space` | 选择文件 |
| `F2` | 重命名文件 |
| `Delete` | 删除文件 |
| `Esc` | 取消操作 |

---

## ♿ 无障碍设计

### 键盘导航
- 完整的 Tab 键导航支持
- 焦点指示器清晰可见

### 屏幕阅读器支持
- 文件项提供 ARIA 标签
- 操作结果语音播报
- 文件状态可检测

---

## 🔒 安全设计

### 危险操作确认

**需要二次确认的操作:**
- 删除文件 / 文件夹
- 覆盖已有文件
- 永久删除(绕过回收站)
- 批量删除(>5 个文件)

**无需确认的操作:**
- 创建新文件
- 重命名文件
- 移动文件
- 复制文件

### 路径遍历防护

**文件路径验证:**
- 防止 `../` 路径遍历攻击
- 白名单验证允许的目录
- 路径规范化

---

## 📊 性能设计

### 大文件处理

**文件大小限制:**
- 单文件上传: 100MB
- 批量上传: 500MB
- 编辑器预览: 10MB (超过则提示下载)
- 图像预览: 10MB

**大文件处理策略:**
- 分片上传(分片大小 5MB)
- 显示上传进度
- 支持断点续传
- 压缩上传(仅文本文件)

### 文件数量限制

**文件树性能:**
- 虚拟滚动(文件 > 100 个时启用)
- 懒加载子文件夹
- 缓存已展开文件夹

---

## 🔧 实现要点

### API 设计

**文件操作 API:**
```typescript
// 文件 CRUD
POST   /api/files           // 创建文件/文件夹
GET    /api/files/:id       // 读取文件
PUT    /api/files/:id       // 更新文件内容
PATCH  /api/files/:id       // 重命名/移动文件
DELETE /api/files/:id       // 删除文件
DELETE /api/files/batch     // 批量删除

// 文件上传/下载
POST   /api/files/upload    // 上传文件
GET    /api/files/:id/download // 下载文件

// 文件搜索
GET    /api/files/search?q=xxx // 搜索文件

// 文件元数据
GET    /api/files/:id/meta  // 获取文件元数据
```

### 组件结构

```tsx
<FileTreePanel>
  <FileTreeHeader />
  <FileTreeList>
    <FileTreeItem />
    <FileTreeItem />
  </FileTreeList>
</FileTreePanel>
<FileOperations>
  <CreateFileModal />
  <DeleteConfirmModal />
  <RenameModal />
  <UploadProgress />
</FileOperations>
```

---

## ✅ 验收清单

### 功能验收
- [ ] 文件创建功能正常
- [ ] 文件重命名功能正常
- [ ] 文件删除功能正常(含撤销)
- [ ] 文件上传功能正常
- [ ] 批量操作功能正常
- [ ] 文件下载功能正常

### 视觉验收
- [ ] 文件图标正确显示
- [ ] 右键菜单样式一致
- [ ] 弹窗布局合理
- [ ] Toast 提示清晰

### 交互验收
- [ ] 键盘导航完整支持
- [ ] 拖拽上传正常工作
- [ ] 快捷键响应正确
- [ ] 二次确认机制有效

### 安全验收
- [ ] 路径遍历防护有效
- [ ] 危险操作有确认提示
- [ ] 文件权限检查正常
- [ ] 删除撤销功能正常

---

## 📸 设计资源

### 图标资源
- **图标库:** Material Icons / Feather Icons
- **尺寸:** 16×16px, 24×24px, 32×32px
- **格式:** SVG

### 颜色变量
```css
:root {
  /* 文件类型颜色 */
  --file-code: #4fc3f7;
  --file-config: #ff9800;
  --file-doc: #4caf50;
  --file-media: #e91e63;
  --file-archive: #795548;

  /* 状态颜色 */
  --status-success: #2e7d32;
  --status-warning: #f57c00;
  --status-error: #c62828;
  --status-info: #1565c0;

  /* 操作颜色 */
  --action-danger: #f44336;
  --action-primary: #007acc;
}
```

---

**设计完成时间:** 2025-02-02
**设计师签名:** Product Designer (Subagent)
**审核状态:** 👁 待审核

---

## 🔄 后续优化方向

### Phase 2 (Sprint 2)
- 文件搜索和过滤功能
- 文件历史和版本管理
- 文件权限和访问控制
- 文件对比功能

### Phase 3 (Sprint 3+)
- 协同编辑功能
- 文件锁定机制
- 自动备份功能
-云存储集成
